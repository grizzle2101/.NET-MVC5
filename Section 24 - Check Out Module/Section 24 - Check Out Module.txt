---Section 24 - Check Out Module:---
---Tutorial 1 - Introdution:---
So in this section we're going to flesh out the checkout section of our application.

Checkout Section:
After Reviewing the shopping cart we can proceed to checkout.
-Shipping Details
-Order Summary Widget
-Diverted to Order Success on completion of form.


Orders:
We also have an Admin & consumer version of the orders page. Admins can see every order whereas
users have the view tailored for them specifically.
Orders - Normal users
Manager Orders - Admin User



---Tutorial 2 - Adding Check Out Button:---


Task 1 - Add CheckOut Button:
So remember we have 2 ways of navigating, we can either redirect in the component using the Router or in this case add a routerLink
into the anchor & voila redirected.

  <a *ngIf="cart.items.length" routerLink="/check-out" class="btn btn-primary">Checkout</a>


Task 2 - Fix Styling:
So the whole point of our application if for users to buy things, lets make the clear cart button a little less conspicious.
btn-light is a nice grey box, styleing looks much better now!
  <p>
    You have {{cart.getTotalItemsCount()}} Item in your Shopping Cart.
    <button *ngIf="cart.items.length" (click)="clearCart()" class="btn btn-light btn-sm">Clear Shopping Cart</button>
  </p>


Test 3 - Test:
Logout, add items into your cart then click checkout. The check-out page is protected so we should be redirected to the login page, then be returned on sucessful
authentication.


---Tutorial 3 - Building a Shipping Form:---
In this section we're going to flesh out the Shipping Form.


Task 1 - Add Form Markup:
The process is very repetitive as we've already done this for products form. Copy & paste in the new markup.

Task 2 - Add Component:
Add the Shopping Cart Object & print to console to verify all is working correctly.



---Tutorial 4 - Saving the Order to Firebase:---



Task 1 - Add Cart subscription:
So before we can do anything we need to add the cart to our component.

  async ngOnInit() {
    let cart$ = await this.cartService.getCartItems();
    this.subscription = cart$.valueChanges().subscribe(cart => this.cart = new ShoppingCart(cart));
  }

  ngOnDestroy(){
    this.subscription.unsubscribe();
  }
  
  placeOrder() {
    console.log(this.shipping);

Task 2 - Create Order Object
So we're going to create an order Object like so, high level shipping details, then iterate through the cart items, extract a few details and save them under product.

    let order = {
      datePlace: new Date().getTime(),
      shipping: this.shipping,
      items: this.cart.items.map(i => {
        return {
          product: {
            title: i.title,
            imageUrl: i.imageUrl,
            price: i.price
          },
          quantity: i.quantity,
          totalPrice: (i.quantity * i.price)
        }
      })
    }
  } 



Task 3 - Create Order Service:
Just Add the order to the orders node and lets check out the result.

export class OrderService {

  constructor(private db: AngularFireDatabase) { }

  storeOrder(order) {
     return this.db.list('/orders').push(order);
  }
}


Result:
So we have a basic order being saved. We have items being stored as an array of numbers as the ID, then the various details.
So the ShoppingCart and Orders have different ways of arranging the data but thats okay. The way we're using orders we don't need to access them, at this point
the user has completed the transaction, the order is set.
In the next section we will look at appending more user information onto the order.



---Tutorial 5 - Associating Order with Current User:---
So to make the orders more useful, It would be useful to have the Current User details, so lets do that.


Task 1 - Retrieve UserID using User Service:
So we have the UserSerive, and the method got getting the current user. Can store this and append to our order object.
-Add UserService to Component
-Store UserID
-Pass to Order Object

  placeOrder() {
    console.log(this.shipping);
    let order = {
      userId: this.userId,
      datePlace: new Date().getTime(),
      shipping: this.shipping,
      items: this.cart.items.map(i => {


Task 2 - Test:
Make sure to test the order creation & verify the userId is appended to the order object.



---Tutorial 6 - Refactoring: Extracting a Rich Model:---
So our placeOrder method is getting very bulky, how can we go about simplfying this code? Lets create a Rich Model to handle this complexity internally.


Task 1 - Order Object:
So if we create an Order Model, we can push much of the logic there.
-Compute DateTime in constructor
-Let Order Object map the various properties.
-set Items(NOT productItems, less detailed order item) in the product node with the basic items needed.

export class Order {
    datePlaced: number;
    items: any[];

    constructor(public userId: string, public shipping: any, shoppingCart: ShoppingCart){
        this.datePlaced = new Date().getTime();

        this.items = shoppingCart.items.map(i => {
            return {
              product: {
                title: i.title,
                imageUrl: i.imageUrl,
                price: i.price
              },
              quantity: i.quantity,
              totalPrice: (i.quantity * i.price)
            }
          })
    }
}

Task 2 - Refactor Component:
Now all that complex messy code has been extracted to our Rich Model.

  placeOrder() {
    console.log(this.shipping);
    let order = new Order(this.userId, this.shipping, this.cart);
    this.orderService.storeOrder(order);
  }    


Task 3 - Test:
Place an order and make sure the same object structure is created.



---Tutorial 7 - Redirecting the User:---
So now that we've settled on the DB model, lets work on redirect the user to Order Success on completion of the order form.
 -Navigate to Order Success with the newly created object ID as a route parameter.

Task 1 - Add ID Parameter to Route:
      {path:'order-success/:id', component: OrderSuccessComponent, canActivate: [AuthGuard]},


Task 2 - Redirect on Completion:
So we have 2 approaches, we could use .then and route, and just await the result and pass the key into our router navigate.

  async placeOrder() {
    console.log(this.shipping);
    let order = new Order(this.userId, this.shipping, this.cart);
    let result = await this.orderService.storeOrder(order);
    this.router.navigate(['order-success', result.key]);
  }    


Task 3 - Test:
So lets test the route, and make sure the correct order key is used, we can later used this to build out an order summary.
http://localhost:4200/order-success/-LZZKnzFstBgtzRpORCf